# 云主机回收站使用示例

## 云主机软删除

> 创建云主机

```
 # nova boot --flavor 2 --block-device id=625d4f2c-cf67-4af3-afb6-c7220f766947,source=image,dest=volume,size=20,shutdown=preserve,bootindex=0 --nic net-id=45b855c7-34df-4002-aabf-c1e80ff352ed  test-max
```

> 查询已创建云主机

```
# nova list
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
| ID                                   | Name     | Status | Task State | Power State | Networks              |
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
| 4c74a62c-cb3c-45c1-b474-f65cdbaf318d | test-max | ACTIVE | -          | Running     | fabian-priv=5.5.5.136 |
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
```
> 查询用户配额使用情况

用户使用配额包含当前新创建云主机配额

> 云主机软删除

```
执行云主机软删除操作
# nova delete 4c74a62c-cb3c-45c1-b474-f65cdbaf318d
Request to delete server 4c74a62c-cb3c-45c1-b474-f65cdbaf318d has been accepted.

# nova list
+----+------+--------+------------+-------------+----------+
| ID | Name | Status | Task State | Power State | Networks |
+----+------+--------+------------+-------------+----------+
+----+------+--------+------------+-------------+----------+

通过查询, 软删除后的云主机已经不可用, nova list无法获取到该云主机信息
```

> 查询用户配额使用情况

用户使用配额中已经不包含处于软删除云主机配额

## 云主机软删除查询

> 云主机软删除查询

用户权限必须为admin权限

```
# nova list --all-tenants --deleted --status soft_deleted
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+
| ID                                   | Name     | Status       | Task State | Power State | Networks              |
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+
| 4c74a62c-cb3c-45c1-b474-f65cdbaf318d | test-max | SOFT_DELETED | -          | Shutdown    | fabian-priv=5.5.5.136 |
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+

```

当回收站的云主机过多时，可以通过`grep 云主机uuid`方式查询单个云主机

## 云主机软删除恢复

用户权限为admin权限

> 查询用户配额使用情况

用户配额使用量不包括等待恢复云主机配额

> 查询云主机信息

```
# nova list
+----+------+--------+------------+-------------+----------+
| ID | Name | Status | Task State | Power State | Networks |
+----+------+--------+------------+-------------+----------+
+----+------+--------+------------+-------------+----------+
```
此时云主机列表中没有等待恢复的云主机信息

> 云主机软删除恢复

```
# nova restore 4c74a62c-cb3c-45c1-b474-f65cdbaf318d
```

> 查询云主机信息

```
# nova list
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
| ID                                   | Name     | Status | Task State | Power State | Networks              |
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
| 4c74a62c-cb3c-45c1-b474-f65cdbaf318d | test-max | ACTIVE | -          | Running     | fabian-priv=5.5.5.136 |
+--------------------------------------+----------+--------+------------+-------------+-----------------------+
```
云主机通过`restore` 已经恢复, 云主机处于`ACTIVE`状态, 云主机列表可查询

> 查询用户配额使用情况

用户配额使用量增加, 包括恢复云主机配额

## 云主机软删除清除

用户权限为admin权限
> 查询软删除云主机

```
# nova list --all-tenants --deleted --status soft_deleted
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+
| ID                                   | Name     | Status       | Task State | Power State | Networks              |
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+
| 4c74a62c-cb3c-45c1-b474-f65cdbaf318d | test-max | SOFT_DELETED | -          | Shutdown    | fabian-priv=5.5.5.136 |
+--------------------------------------+----------+--------------+------------+-------------+-----------------------+

```

> 云主机软删除清除

```
# nova force-delete 4c74a62c-cb3c-45c1-b474-f65cdbaf318d
```

> 查询软删除云主机

```
# nova list --all-tenants --deleted --status soft_deleted
+----+------+--------+------------+-------------+----------+
| ID | Name | Status | Task State | Power State | Networks |
+----+------+--------+------------+-------------+----------+
+----+------+--------+------------+-------------+----------+

```
软删除中已经没有清除的云主机ID, 云主机不可再恢复


